---
## OWASP Dependency-Check GitHub Actions ##
name: OWASP Dependency Check

# Run weekly on Mondays at 00:00 UTC
on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF results

# Set the Job
jobs:
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      # Checkout the code base
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          fetch-depth: 0

      # Run OWASP Dependency-Check
      - name: Run OWASP Dependency-Check
        id: dependency-check
        continue-on-error: true
        uses: dependency-check/Dependency-Check_Action@1e54355a8b4c8abaa8cc7d0b70aa655a3bb15a6c # main as of 2025-11-21
        env:
          JAVA_HOME: /opt/jdk
        with:
          project: 'newsdedup'
          path: '.'
          format: 'HTML,JSON,SARIF'
          args: >
            --enableRetired
            --enableExperimental
            --scan './**/*.py'
            --scan './requirements.txt'
            --scan './pyproject.toml'

      # Check if reports were generated
      - name: Check for generated reports
        id: check-reports
        run: |
          if [ -f "reports/dependency-check-report.sarif" ]; then
            echo "sarif_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "sarif_exists=false" >> "$GITHUB_OUTPUT"
            echo "::warning::SARIF report was not generated"
          fi
          if [ -d "reports" ] && [ "$(ls -A reports)" ]; then
            echo "reports_exist=true" >> "$GITHUB_OUTPUT"
          else
            echo "reports_exist=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No reports were generated"
          fi

      # Upload results as artifacts
      - name: Upload Dependency-Check Report
        uses: actions/upload-artifact@v6
        if: steps.check-reports.outputs.reports_exist == 'true'
        with:
          name: dependency-check-report
          path: reports/

      # Upload SARIF file to GitHub Security tab
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: steps.check-reports.outputs.sarif_exists == 'true'
        with:
          sarif_file: reports/dependency-check-report.sarif
